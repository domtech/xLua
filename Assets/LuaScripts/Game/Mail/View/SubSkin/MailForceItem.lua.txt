---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by pengzhou.
--- DateTime: 2019-09-26 14:16
---
local NotificationConst = require('Game/Common/Const/NotificationConst');
local tData;
local tRender;

---标题资源
local tResourceData = {
    {flag = "attack", color = "[EC6941]"}, 
    {flag = "defense", color = "[00BAFF]"}
}


function initText()
    -- body
    -- self.itemTitle.text = CS.Language.GetContent("mass012"); --  部队详情
    lable1.text = CS.Language.GetContent("battleReport104"); --  部队总数
    lable2.text = CS.Language.GetContent("ranking015"); --  击杀
    lable3.text = CS.Language.GetContent("battleReport106"); --  阵亡
    lable4.text = CS.Language.GetContent("battleReport107"); --  重伤
    lable5.text = CS.Language.GetContent("battleReport108"); --  轻伤
end

--创建完item回调
---@param render BaseScriptItemRenderViewForLua
function OnPostCreateRender(render)
    tRender = render;

    CS.UIEventListener.Get(dragonBg.gameObject).onClick = onBtnClick;
    initText();
end

--返回item数据
function GetData()
    return tData;
end

--保存item数据
---@param data RewardObject
function SetData(data)
    tData = data;
    Refresh();
end

--刷新item
function Refresh()
    if nil ~= tData then
        tRender.viewObject:SetActive(true);
        Render(tData);
    else
        tRender.viewObject:SetActive(false);
    end
end

--- @param data MailBattleDetailVO
function Render(data)

    local isAttacker = data.isAttacker == true and 1 or 2;
    local tFlag = tResourceData[isAttacker]
    if data.player ~= nil then
        if data.player.allianceAlias ~= nil then
            itemTitle.text =  tFlag.color .. data.player.allianceAlias .. data.player.name;
        else
            itemTitle.text =  tFlag.color .. data.player.name;
        end
    end
    flag.spriteName = tFlag.flag;

    dragonTable = CS.BaseUIMediatorForLua.GetTableByLuaBehaviour(dragon, "");
    if data.dragonList ~= nil and data.dragonList.Count > 0 then
        -- body
        dragonTable:init(data.dragonList[0]);

        dragon:SetActive(true);
        empty:SetActive(false);
    else
        dragon:SetActive(false);
        empty:SetActive(true);
    end
   
    dragonLable1.text = tostring(data.totalSoldierCount);
    dragonLable2.text = tostring(data.kill);
    dragonLable3.text = tostring(data.deadSoldierCount);
    dragonLable4.text = tostring(data.woundSoldierCount);
    dragonLable5.text = tostring(data.captiveSoldierCount);

    if data.allSoldiers ~= nil and data.allSoldiers.Count > 0 then
        -- body
        refreshSoldiers(data.allSoldiers.Count);
        soldierTable:Reposition();
        showSoldier(true)

        for i = 1, data.allSoldiers.Count do
            soldiers[i]:init(data.allSoldiers[i-1]);
            soldiers[i]:showLine(i ~= data.allSoldiers.Count);
        end
    else
        showSoldier(false)
    end
    
    bg:Execute();
end

--- refreshSoldiers 
--- @param num 士兵个数
function refreshSoldiers(num)
    if soldiers == nil or  num > #soldiers then  
        -- 新增节点
        if soldiers == nil then
            soldiers = {}
        end

        for i = 1, num - #soldiers do
            -- body
            local item = CS.UnityEngine.GameObject.Instantiate(soldierGo);
            item.transform:SetParent(soldierTable.transform, false);
            local soldierItem = CS.BaseUIMediatorForLua.GetTableByLuaBehaviour(item, "");
            soldierItem.item = item;
            table.insert(soldiers, soldierItem);
        end
    end

    for index, value in ipairs(soldiers) do
        -- body
        soldiers[index].item:SetActive(index <= num)
    end
end

function showSoldier( isShow)
    -- body
    soldierTable.gameObject:SetActive(isShow);
    if isShow then
        dragonBg.spriteName = "bg_mail_main_list02"
    else
        dragonBg.spriteName = "bg_mail_main_list01"
    end
    
    bg:Execute();
end

function onBtnClick(go)
    -- bod
    local flag = soldierTable.gameObject.activeSelf
    showSoldier(not flag);
    CS.ApplicationFacade.instance:SendNotification(NotificationConst.ON_MAIL_DETAIL_SOLDIER_CLIKC); 
end

function OnDestroy()
end

